name: Build and Release Multi-Platform App

on:
  push:
    tags:
      - 'v*'   # 仅在推送以 v 开头的标签时触发
  workflow_dispatch:  # 也允许手动触发

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # 根据你的实际需求设置

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p templates static
          if [ ! -f "templates/index.html" ]; then
            echo "Warning: templates/index.html not found, creating placeholder"
            echo "<html><body><h1>pan123-scraper</h1></body></html>" > templates/index.html
          fi
          if [ ! -f "static/style.css" ]; then
            echo "Warning: static/style.css not found, creating placeholder"
            echo "/* pan123-scraper styles */" > static/style.css
          fi
          if [ ! -f "static/script.js" ]; then
            echo "Warning: static/script.js not found, creating placeholder"
            echo "// pan123-scraper scripts" > static/script.js
          fi

      - name: Verify spec file exists
        run: |
          if [ ! -f "pan123-scraper.spec" ]; then
            echo "Error: pan123-scraper.spec not found!"
            exit 1
          fi
          echo "✅ PyInstaller spec file found"

      - name: Build EXE with PyInstaller (Windows)
        run: |
          pyinstaller pan123-scraper.spec

      - name: Verify build output
        run: |
          ls -la dist/
          if [ ! -f "dist/pan123-scraper-win.exe" ]; then
            echo "Error: Windows executable not found!"
            exit 1
          fi
          echo "✅ Windows executable built successfully"

      - name: Upload Windows EXE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-windows
          path: dist/*.exe

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p templates static
          if [ ! -f "templates/index.html" ]; then
            echo "Warning: templates/index.html not found, creating placeholder"
            echo "<html><body><h1>pan123-scraper</h1></body></html>" > templates/index.html
          fi
          if [ ! -f "static/style.css" ]; then
            echo "Warning: static/style.css not found, creating placeholder"
            echo "/* pan123-scraper styles */" > static/style.css
          fi
          if [ ! -f "static/script.js" ]; then
            echo "Warning: static/script.js not found, creating placeholder"
            echo "// pan123-scraper scripts" > static/script.js
          fi

      - name: Verify spec file exists
        run: |
          if [ ! -f "pan123-scraper.spec" ]; then
            echo "Error: pan123-scraper.spec not found!"
            exit 1
          fi
          echo "✅ PyInstaller spec file found"

      - name: Build Executable with PyInstaller (Linux)
        run: |
          pyinstaller pan123-scraper.spec

      - name: Verify build output
        run: |
          ls -la dist/
          if [ ! -f "dist/pan123-scraper-linux" ]; then
            echo "Error: Linux executable not found!"
            exit 1
          fi
          echo "✅ Linux executable built successfully"

      - name: Upload Linux Executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-linux
          path: dist/* # Linux可执行文件没有.exe后缀

  build_macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p templates static
          if [ ! -f "templates/index.html" ]; then
            echo "Warning: templates/index.html not found, creating placeholder"
            echo "<html><body><h1>pan123-scraper</h1></body></html>" > templates/index.html
          fi
          if [ ! -f "static/style.css" ]; then
            echo "Warning: static/style.css not found, creating placeholder"
            echo "/* pan123-scraper styles */" > static/style.css
          fi
          if [ ! -f "static/script.js" ]; then
            echo "Warning: static/script.js not found, creating placeholder"
            echo "// pan123-scraper scripts" > static/script.js
          fi

      - name: Verify spec file exists
        run: |
          if [ ! -f "pan123-scraper.spec" ]; then
            echo "Error: pan123-scraper.spec not found!"
            exit 1
          fi
          echo "✅ PyInstaller spec file found"

      - name: Build App with PyInstaller (macOS)
        run: |
          pyinstaller pan123-scraper.spec

      - name: Verify build output
        run: |
          ls -la dist/
          if [ ! -f "dist/pan123-scraper-mac" ]; then
            echo "Error: macOS executable not found!"
            exit 1
          fi
          echo "✅ macOS executable built successfully"

      - name: Upload macOS App/Executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-macos
          path: dist/* # macOS的产物可能是可执行文件或.app目录

  create_release:
    needs: [build_windows, build_linux, build_macos] # 确保所有构建作业完成后再创建Release
    runs-on: ubuntu-latest # 可以在任意一个平台上运行
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts # 将所有下载的artifact放在这个目录

      - name: List downloaded artifacts (for debugging)
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/pan123-scraper-windows/*.exe
            artifacts/pan123-scraper-linux/*
            artifacts/pan123-scraper-macos/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
