name: Build and Release Multi-Platform App

on:
  push:
    tags:
      - 'v*'   # ä»…åœ¨æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # ä¹Ÿå…è®¸æ‰‹åŠ¨è§¦å‘

# è®¾ç½®æƒé™ä»¥å…è®¸åˆ›å»ºRelease
permissions:
  contents: write
  packages: write

jobs:
  build_windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' # æ ¹æ®ä½ çš„å®é™…éœ€æ±‚è®¾ç½®

      - name: Build with PowerShell script
        shell: pwsh
        run: |
          .\build-windows.ps1

      - name: Upload Windows EXE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-windows
          path: dist/*.exe

  build_linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build with bash script
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Upload Linux Executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-linux
          path: dist/* # Linuxå¯æ‰§è¡Œæ–‡ä»¶æ²¡æœ‰.exeåç¼€

  build_macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Build with bash script
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Upload macOS App/Executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: pan123-scraper-macos
          path: dist/* # macOSçš„äº§ç‰©å¯èƒ½æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ–.appç›®å½•

  create_release:
    needs: [build_windows, build_linux, build_macos] # ç¡®ä¿æ‰€æœ‰æ„å»ºä½œä¸šå®Œæˆåå†åˆ›å»ºRelease
    runs-on: ubuntu-latest # å¯ä»¥åœ¨ä»»æ„ä¸€ä¸ªå¹³å°ä¸Šè¿è¡Œ
    if: startsWith(github.ref, 'refs/tags/') # åªåœ¨æ ‡ç­¾æ¨é€æ—¶åˆ›å»ºRelease
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts # å°†æ‰€æœ‰ä¸‹è½½çš„artifactæ”¾åœ¨è¿™ä¸ªç›®å½•

      - name: List downloaded artifacts (for debugging)
        run: |
          echo "ğŸ“¦ ä¸‹è½½çš„æ„å»ºäº§ç‰©ï¼š"
          ls -la artifacts/
          echo "ğŸ“ è¯¦ç»†å†…å®¹ï¼š"
          find artifacts/ -type f -exec ls -la {} \;

      - name: Prepare release files
        run: |
          mkdir -p release_files
          # å¤åˆ¶å¹¶é‡å‘½åæ–‡ä»¶ä»¥ç¡®ä¿æ­£ç¡®çš„æ–‡ä»¶å
          if [ -f artifacts/pan123-scraper-windows/pan123-scraper-win.exe ]; then
            cp artifacts/pan123-scraper-windows/pan123-scraper-win.exe release_files/
            echo "âœ… Windowså¯æ‰§è¡Œæ–‡ä»¶å·²å‡†å¤‡"
          fi
          if [ -f artifacts/pan123-scraper-linux/pan123-scraper-linux ]; then
            cp artifacts/pan123-scraper-linux/pan123-scraper-linux release_files/
            echo "âœ… Linuxå¯æ‰§è¡Œæ–‡ä»¶å·²å‡†å¤‡"
          fi
          if [ -f artifacts/pan123-scraper-macos/pan123-scraper-mac ]; then
            cp artifacts/pan123-scraper-macos/pan123-scraper-mac release_files/
            echo "âœ… macOSå¯æ‰§è¡Œæ–‡ä»¶å·²å‡†å¤‡"
          fi
          echo "ğŸ“‹ Releaseæ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la release_files/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release_files/*
          name: "pan23-scraper ${{ github.ref_name }}"
          body: |
            ## ğŸ‰ pan23-scraper ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½
            - **Windows**: pan123-scraper-win.exe
            - **Linux**: pan123-scraper-linux
            - **macOS**: pan123-scraper-mac

            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å¯æ‰§è¡Œæ–‡ä»¶
            2. åˆ›å»º `config.json` é…ç½®æ–‡ä»¶
            3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
            4. è®¿é—® http://localhost:5001

            ### âœ¨ ä¸»è¦åŠŸèƒ½
            - ğŸŒ 123äº‘ç›˜æ–‡ä»¶ç®¡ç†
            - ğŸ¤– AIæ™ºèƒ½åˆ†ç»„
            - ğŸ¬ TMDBåª’ä½“åˆ®å‰Š
            - ğŸ“ æ‰¹é‡é‡å‘½å
            - ğŸ”’ å®‰å…¨é…ç½®ç®¡ç†

            ### ğŸ“‹ æ›´æ–°å†…å®¹
            è¯·æŸ¥çœ‹æäº¤å†å²äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
